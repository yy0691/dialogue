好的，完全没有问题。

经过我们前面详细的探讨和决策，现在我们可以将您的最终需求，整理成一份清晰、完整、可直接交付给开发人员的 Python 项目需求文档。

这份文档总结了我们所有的关键决定，特别是关于**“固定用户选项”与“受控的AI生成回答”**的核心机制。

SBMA 遗传咨询 AI 对-话仿真系统 - Python 开发需求文档
1. 项目概述
1.1 项目目标
开发一个基于Python的应用程序，用于模拟“脊髓延髓侧索硬化症(SBMA)”的遗传咨询过程。该程序旨在提供一个高度真实和动态的对话体验，其中咨询师（AI）的回答由大语言模型（LLM）实时生成，而用户（咨询者）的回答则从预设的固定选项中选择。

1.2 核心交互模式

用户（咨询者）： 用户的输入方式是非开放的。在对话的每一步，系统会提供一个或多个预设的回答选项，用户通过选择其中之一来推动对话进行。这确保了对话始终在预设的逻辑框架内进行。

AI（咨询师）： AI的回答是动态生成的。系统不会使用固定的、预先写好的台词，而是根据当前对话的目标和上下文，通过调用LLM API实时生成一段自然且专业的回复。

2. 数据源规范
2.1 文件格式

项目的主要数据源是一个 CSV (逗号分隔值) 文件，建议命名为 dialogue_source.csv。

该CSV文件是所有对话逻辑、AI指令和用户选项的唯一真实来源 (Single Source of Truth)，便于非技术人员（如编剧、医学专家）进行内容的维护和迭代。

2.2 数据结构 (CSV列名)
CSV文件必须包含以下英文列名，以便于程序解析：

列名 (Header)	数据类型	描述
ID	文本	唯一标识符。每个对话节点/步骤的唯一ID，如 "M1-01"。
Scene/Node Description	文本	对当前节点的简要描述，供设计者参考。
Action/Note	文本	记录当前节点需要执行的特殊动作或备注，如“医生请坐手势”。
Primary Dialogue	文本	核心对话内容/目标。这是该节点AI回答的核心思想，将作为构建Prompt的关键部分。
Alternative Phrasing 1	文本	备选表达方式1。用于为AI提供风格和措辞上的参考。
Alternative Phrasing 2	文本	备选表达方式2。
Alternative Phrasing 3	文本	备选表达方式3 (可扩展更多列)。
Character	文本	定义当前节点的说话角色，主要应为“咨询师”。
Choice 1 Text	文本	在当前节点结束后，呈现给用户的第一个选项按钮的文本。
Choice 1 nextNode	文本	当用户选择第一个选项后，对话应跳转到的下一个节点的ID。
Choice 2 Text	文本	第二个选项按钮的文本 (如果存在)。
Choice 2 nextNode	文本	第二个选项对应的跳转ID。
...	文本	可扩展更多 Choice X Text / Choice X nextNode 列。
Trigger Event/Resource	文本	定义在此节点需要触发的程序事件或加载的媒体资源。

Export to Sheets
2.3 数据转换脚本

项目包含一个辅助的Python脚本 (convert.py)，其功能是将 dialogue_source.csv 文件转换为结构更优的 dialogue_output.json 文件。

主应用程序应直接读取这个JSON文件，因为在程序中处理JSON比处理CSV更高效、更方便。

3. 核心功能需求
3.1 对话状态管理

程序必须维护一个“状态变量”，用于时刻追踪当前对话进行到了哪一个ID。

程序的初始状态应为起始ID（例如 "M1-01"）。

用户的每次选择都会根据 nextNode 的值来更新这个状态变量。

3.2 对话引擎主循环
程序应遵循以下逻辑循环：

启动： 加载 dialogue_output.json 数据，并初始化状态为起始ID。

获取当前节点数据： 根据当前的状态ID，从JSON数据中查找对应的节点信息（包括Character, Primary Dialogue, Alternative Phrasing, Choices等）。

判断角色：

如果Character是“咨询师”，则进入步骤4（AI生成）。

如果Character是“咨询者”，则跳过AI生成，直接进入步骤6（展示选项）。

构建动态提示词 (Prompt)： (详见3.3)

调用LLM API： 将构建好的提示词发送给大语言模型，并获取返回的文本作为咨询师的回答。

呈现给用户：

在界面上显示AI生成的回答（或当前节点的Primary Dialogue，如果不需要AI生成）。

从当前节点数据的 choices 数组中，读取所有选项，并在界面上为用户生成对应的按钮。

等待用户输入： 程序暂停，等待用户点击其中一个选项按钮。

更新状态： 当用户点击按钮后，程序获取该选项关联的nextNode值，将其设为新的状态ID，然后返回步骤2，开始下一轮循环。

3.3 动态提示词构建
这是AI生成回答的核心。每次调用LLM前，程序都必须动态构建一个包含以下元素的提示词：

固定人设 (Persona)： “你是一名专业的遗传咨询师，风格富有同理心且专业...”

对话上下文 (Context)： 用户上一轮选择的选项文本。例如：“用户刚刚选择了：‘我舅舅今年50岁。’”

核心任务 (Goal)： 当前节点中的 Primary Dialogue 内容。

风格参考 (Examples)： 当前节点中的 Alternative Phrasing 数组内容。

输出要求 (Constraints)： 明确要求AI只输出对话内容，不要有额外解释。

4. 技术栈与实现建议
核心库：

csv / pandas: 用于 convert.py 脚本中读取CSV。

json: 用于在主程序中加载 dialogue_output.json。

google-generativeai 或 openai: 根据您选择的LLM，使用其官方Python SDK。

UI建议： 为了快速测试，初期可使用简单的命令行界面（CLI），通过 print() 展示AI回答，用 input() 让用户输入数字来选择选项。

这份文档清晰地定义了项目的目标、数据结构和核心功能，希望能为您的Python搭建工作提供一个坚实的蓝图。